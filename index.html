<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebGIS - Infraestructura peatonal</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f5f5;
    }

    header {
      padding: 0.75rem 1rem;
      background: #1f2937;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    header p {
      margin: 0;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      height: calc(100vh - 56px);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .panel-formulario {
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      overflow-y: auto;
    }

    .panel-formulario h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    .help {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.5rem;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    input[type="text"],
    select,
    textarea,
    input[type="file"] {
      width: 100%;
      padding: 0.3rem 0.4rem;
      font-size: 0.8rem;
      border-radius: 0.25rem;
      border: 1px solid #d1d5db;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .fila-coords {
      display: flex;
      gap: 0.5rem;
    }

    .fila-coords input {
      flex: 1;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid #111827;
      background: #111827;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .small {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .lista-reportes {
      margin-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
      padding-top: 0.5rem;
    }

    .item-reporte {
      font-size: 0.8rem;
      padding: 0.25rem 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        height: auto;
      }

      #map {
        height: 55vh; /* mapa ocupa ~mitad de la pantalla */
      }

      .panel-formulario {
        border-left: none;
        border-top: 1px solid #e5e7eb;
        height: auto;
        padding-bottom: 1.5rem;
      }

      button {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }

      input[type="text"],
      select,
      textarea,
      input[type="file"] {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>WebGIS - Afectaci√≥n de infraestructura peatonal</h1>
    <p>La comunidad reporta problemas en veredas, cruces y accesibilidad.</p>
  </header>

  <div class="layout">
    <!-- Mapa -->
    <div id="map"></div>

    <!-- Formulario -->
    <aside class="panel-formulario">
      <h2>Nuevo reporte ciudadano</h2>
      <p class="help">
        1) Al abrir el visor se intentar√° usar tu ubicaci√≥n actual autom√°ticamente.<br />
        2) Si no funciona o prefieres otro lugar, toca el mapa para marcar la ubicaci√≥n del problema.<br />
        3) Puedes tomar una foto o subirla desde tu galer√≠a.<br />
        4) Completa el formulario y presiona <strong> reporte</strong>.
      </p>

      <form id="form-reporte">
        <label>Coordenadas (GPS o clic en el mapa):</label>
        <div class="fila-coords">
          <input type="text" id="lat" placeholder="Latitud" readonly />
          <input type="text" id="lng" placeholder="Longitud" readonly />
        </div>

        <label for="tipo_afectacion">Tipo de afectaci√≥n:</label>
        <select id="tipo_afectacion" required>
          <option value="">Selecciona una opci√≥n</option>
          <option value="Vereda da√±ada">Vereda da√±ada</option>
          <option value="Cruce peligroso">Cruce peligroso</option>
          <option value="Inundaci√≥n en vereda">Inundaci√≥n en vereda</option>
          <option value="Iluminaci√≥n deficiente">Iluminaci√≥n deficiente</option>
          <option value="Otro">Otro</option>
        </select>

        <label for="superficie">Tipo de superficie:</label>
        <select id="superficie" required>
          <option value="">Selecciona una opci√≥n</option>
          <option value="Vereda">Vereda</option>
          <option value="Cruce">Cruce</option>
          <option value="Pasarela">Pasarela</option>
          <option value="Plaza / √°rea verde">Plaza / √°rea verde</option>
          <option value="Otro">Otro</option>
        </select>

        <label for="severidad">Severidad del problema:</label>
        <select id="severidad" required>
          <option value="">Selecciona una opci√≥n</option>
          <option value="Baja">Baja</option>
          <option value="Media">Media</option>
          <option value="Alta">Alta</option>
        </select>

        <label for="iluminacion">Iluminaci√≥n del sector:</label>
        <select id="iluminacion" required>
          <option value="">Selecciona una opci√≥n</option>
          <option value="Buena">Buena</option>
          <option value="Regular">Regular</option>
          <option value="Mala">Mala</option>
        </select>

        <label for="accesibilidad">¬øEs accesible para silla de ruedas / coche?</label>
        <select id="accesibilidad" required>
          <option value="">Selecciona una opci√≥n</option>
          <option value="S√≠">S√≠</option>
          <option value="No">No</option>
        </select>

        <label for="descripcion">Descripci√≥n del problema:</label>
        <textarea id="descripcion" placeholder="Ej: Vereda rota cerca de colegio, personas mayores tropiezan..."></textarea>

        <label for="fecha">Fecha (opcional):</label>
        <input type="date" id="fecha" />

        <label for="foto">Fotograf√≠a (opcional):</label>
        <input
          type="file"
          id="foto"
          accept="image/*"
          capture="environment"
        />

        <button type="submit" id="btn-guardar" disabled>Guardar reporte</button>
        <p class="small">
          El bot√≥n se habilita cuando el sistema obtiene tu ubicaci√≥n o cuando seleccionas una en el mapa.
        </p>
      </form>

      <div class="lista-reportes">
        <strong>Reportes registrados en esta sesi√≥n:</strong>
        <div id="lista-reportes-items"></div>
      </div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =====================================================
// CONFIGURACI√ìN SUPABASE
// =====================================================
// üëá YA CONFIGURASTE ESTO:
const SUPABASE_URL = "https://lcuhjpstmkaonpbnlpmi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdWhqcHN0bWthb25wYm5scG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTgxODUsImV4cCI6MjA4MDE5NDE4NX0.PXaT-o-7BeV5CtFu1VPSpXL0_MTnzFjraBdYCXSWmcQ";

// crear cliente supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =====================================================
// FUNCI√ìN PARA GUARDAR EN SUPABASE (con Storage)
// =====================================================
async function guardarEnSupabase(feature) {

  let fotoURL = null;

  // 1) Subir foto al bucket si existe base64
  if (feature.properties.foto_dataurl) {
    const base64 = feature.properties.foto_dataurl;
    const fileName = `foto_${Date.now()}.jpg`;

    try {
      // convertir dataURL -> Blob
      const res = await fetch(base64);
      const blob = await res.blob();

      // subir a Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('fotos_reportes')
        .upload(fileName, blob, {
          contentType: 'image/jpeg',
          upsert: false,
        });

      if (uploadError) {
        console.error("‚ùå ERROR SUBIENDO FOTO:", uploadError);
      } else {
        // construir URL p√∫blica
        fotoURL = `${SUPABASE_URL}/storage/v1/object/public/fotos_reportes/${fileName}`;
      }
    } catch (e) {
      console.error("‚ùå Error convirtiendo base64 a Blob:", e);
    }
  }

  // 2) Insertar reporte en la tabla
  const { data, error } = await supabase
    .from("reportes")
    .insert({
      lat: feature.geometry.coordinates[1],
      lng: feature.geometry.coordinates[0],
      tipo_afectacion: feature.properties.tipo_afectacion,
      superficie: feature.properties.superficie,
      severidad: feature.properties.severidad,
      iluminacion: feature.properties.iluminacion,
      accesibilidad: feature.properties.accesibilidad,
      descripcion: feature.properties.descripcion,
      fecha: feature.properties.fecha || null,
      foto_url: fotoURL,       // üëà ahora guardamos la URL
      aprobado: false
    });

  if (error) {
    console.error("‚ùå ERROR SUPABASE (insert):", error);
    alert("‚ùå Error guardando el reporte.");
  } else {
    console.log("‚úÖ Guardado en Supabase:", data);
    alert("‚úÖ Reporte guardado correctamente.");
  }
}

// =====================================================
// MAPA
// =====================================================
const map = L.map("map").setView([-37.47, -72.35], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// =====================================================
// CAPA DE REPORTES
// =====================================================
let reportes = { type: "FeatureCollection", features: [] };
let contadorId = 1; // se actualizar√° con los datos de Supabase

const listaReportesDiv = document.getElementById("lista-reportes-items");

let capaReportes = L.geoJSON(null, {
  pointToLayer: (feature, latlng) =>
    L.circleMarker(latlng, {
      radius: 7,
      fillColor: getColor(feature.properties.tipo_afectacion),
      color: "#333",
      weight: 1,
      fillOpacity: 0.9
    }),
  onEachFeature: (feature, layer) => {
    const p = feature.properties;
    let html = `
      <b>Tipo de afectaci√≥n:</b> ${p.tipo_afectacion}<br>
      <b>Superficie:</b> ${p.superficie}<br>
      <b>Severidad:</b> ${p.severidad}<br>
      <b>Iluminaci√≥n:</b> ${p.iluminacion}<br>
      <b>Accesibilidad:</b> ${p.accesibilidad}<br>
      <b>Fecha:</b> ${p.fecha || "-"}<br>
      <b>Descripci√≥n:</b> ${p.descripcion || "-"}
    `;
    if (p.foto_url) {
    html += `<br><img src="${p.foto_url}" style="max-width:200px; margin-top:4px;">`;
    } else if (p.foto_dataurl) {
    // por si quedaron reportes viejos con base64
    html += `<br><img src="${p.foto_dataurl}" style="max-width:200px; margin-top:4px;">`;
    }
    layer.bindPopup(html);
  }
}).addTo(map);

// =====================================================
// CARGAR REPORTES EXISTENTES DESDE SUPABASE
// =====================================================
async function cargarReportesIniciales() {
  const { data, error } = await supabase
    .from("reportes")
    .select("*")
    .eq("aprobado", true);

  if (error) {
    console.error("‚ùå ERROR SUPABASE (select):", error);
    return;
  }

  if (!data) return;

  data.forEach(row => {
    if (row.lat == null || row.lng == null) return;

    const feature = {
      type: "Feature",
      properties: {
        id_reporte: row.id,
        tipo_afectacion: row.tipo_afectacion,
        superficie: row.superficie,
        severidad: row.severidad,
        iluminacion: row.iluminacion,
        accesibilidad: row.accesibilidad,
        descripcion: row.descripcion,
        fecha: row.fecha,
        foto_url: row.foto_url
      },
      geometry: {
        type: "Point",
        coordinates: [row.lng, row.lat]
      }
    };

    reportes.features.push(feature);
    capaReportes.addData(feature);

    // a√±adir tambi√©n a la lista lateral
    const item = document.createElement("div");
    item.className = "item-reporte";
    item.textContent = `${feature.properties.id_reporte}. ${row.tipo_afectacion} (${row.severidad})`;
    listaReportesDiv.appendChild(item);

    // mantener contadorId por encima del m√°ximo id
    if (row.id >= contadorId) {
      contadorId = row.id + 1;
    }
  });

  console.log(`‚úÖ Reportes iniciales cargados: ${data.length}`);
}

// llamar una vez al iniciar
cargarReportesIniciales();

// =====================================================
// UBICACI√ìN Y CLIC EN EL MAPA
// =====================================================
let marcadorTemporal = null;

const latInput = document.getElementById("lat");
const lngInput = document.getElementById("lng");
const btnGuardar = document.getElementById("btn-guardar");

function actualizarUbicacion(lat, lng) {
  latInput.value = lat.toFixed(6);
  lngInput.value = lng.toFixed(6);
  btnGuardar.disabled = false;

  const punto = L.latLng(lat, lng);

  if (marcadorTemporal) marcadorTemporal.setLatLng(punto);
  else marcadorTemporal = L.marker(punto).addTo(map);

  map.setView(punto, map.getZoom());
}

map.on("click", e => actualizarUbicacion(e.latlng.lat, e.latlng.lng));

if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(
    pos => actualizarUbicacion(pos.coords.latitude, pos.coords.longitude),
    err => console.warn("No se pudo obtener GPS:", err),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// =====================================================
// COLORES
// =====================================================
function getColor(tipo) {
  switch (tipo) {
    case "Vereda da√±ada": return "#e41a1c";
    case "Cruce peligroso": return "#377eb8";
    case "Inundaci√≥n en vereda": return "#4daf4a";
    case "Iluminaci√≥n deficiente": return "#984ea3";
    default: return "#ff7f00";
  }
}

// =====================================================
// FORMULARIO
// =====================================================
const form = document.getElementById("form-reporte");

let fotoDataURLActual = null;
document.getElementById("foto").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return (fotoDataURLActual = null);

  const reader = new FileReader();
  reader.onload = ev => { fotoDataURLActual = ev.target.result; };
  reader.readAsDataURL(file);
});

form.addEventListener("submit", function (e) {
  e.preventDefault();

  if (!latInput.value || !lngInput.value) {
    alert("Primero selecciona una ubicaci√≥n.");
    return;
  }

  const tipo_afectacion = document.getElementById("tipo_afectacion").value;
  const superficie = document.getElementById("superficie").value;
  const severidad = document.getElementById("severidad").value;
  const iluminacion = document.getElementById("iluminacion").value;
  const accesibilidad = document.getElementById("accesibilidad").value;
  const descripcion = document.getElementById("descripcion").value;
  const fecha = document.getElementById("fecha").value;

  if (!tipo_afectacion || !superficie || !severidad || !iluminacion || !accesibilidad) {
    alert("Completa todos los campos obligatorios.");
    return;
  }

  const lat = parseFloat(latInput.value);
  const lng = parseFloat(lngInput.value);

  const feature = {
    type: "Feature",
    properties: {
      id_reporte: contadorId++,
      tipo_afectacion,
      superficie,
      severidad,
      iluminacion,
      accesibilidad,
      descripcion,
      fecha,
      foto_dataurl: fotoDataURLActual
    },
    geometry: {
      type: "Point",
      coordinates: [lng, lat]
    }
  };

  reportes.features.push(feature);
  capaReportes.addData(feature);

  const item = document.createElement("div");
  item.className = "item-reporte";
  item.textContent = `${feature.properties.id_reporte}. ${tipo_afectacion} (${severidad})`;
  listaReportesDiv.appendChild(item);

  // guardar en Supabase
  guardarEnSupabase(feature);

  form.reset();
  btnGuardar.disabled = true;
  fotoDataURLActual = null;
});

// =====================================================
// ESCUCHAR NUEVOS REPORTES EN TIEMPO REAL
// =====================================================
supabase
  .channel('realtime:reportes')
  .on(
    'postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'reportes' },
    payload => {
      console.log('üì° Nuevo reporte recibido en vivo:', payload);

      const row = payload.new;
      if (!row.aprobado) {
          return;
      }

      const feature = {
        type: "Feature",
        properties: {
          id_reporte: row.id,
          tipo_afectacion: row.tipo_afectacion,
          superficie: row.superficie,
          severidad: row.severidad,
          iluminacion: row.iluminacion,
          accesibilidad: row.accesibilidad,
          descripcion: row.descripcion,
          fecha: row.fecha,
          foto_url: row.foto_url
        },
        geometry: {
          type: "Point",
          coordinates: [row.lng, row.lat]
        }
      };

      reportes.features.push(feature);
      capaReportes.addData(feature);

      const item = document.createElement("div");
      item.className = "item-reporte";
      item.textContent = `${row.id}. ${row.tipo_afectacion} (${row.severidad})`;
      listaReportesDiv.appendChild(item);
    }
  )
  .subscribe();
</script>







